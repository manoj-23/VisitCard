<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visiting Card Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- ✅ Stable OCR version -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

  <!-- Login Section -->
  <div id="login-section" class="bg-white shadow-md rounded-xl p-6 w-full max-w-sm">
    <h2 class="text-2xl font-bold mb-4 text-center">Admin Login</h2>
    <input id="login-user" type="text" placeholder="Username" class="border p-2 w-full mb-3 rounded" />
    <input id="login-pass" type="password" placeholder="Password" class="border p-2 w-full mb-4 rounded" />
    <button id="btn-login" class="bg-blue-600 text-white px-4 py-2 rounded w-full hover:bg-blue-700">Login</button>
    <p id="login-status" class="text-center text-red-500 mt-2"></p>
  </div>

  <!-- Dashboard Section -->
  <div id="dashboard" class="hidden w-full max-w-3xl">
    <h2 class="text-2xl font-bold text-center mb-4">Visiting Card Dashboard</h2>

    <!-- Upload Form -->
    <div class="bg-white shadow-md rounded-xl p-4 mb-6">
      <input type="file" id="file-input" accept="image/*" class="mb-3" />
      <button id="btn-run-ocr" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Run OCR</button>
      <p id="ocr-status" class="text-blue-600 text-sm mt-2"></p>

      <div id="preview" class="mt-4 hidden">
        <img id="card-image" class="w-48 rounded shadow mb-3" />
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <input id="field-name" placeholder="Name" class="border p-2 rounded" />
          <input id="field-email" placeholder="Email" class="border p-2 rounded" />
          <input id="field-phone" placeholder="Phone" class="border p-2 rounded" />
          <input id="field-company" placeholder="Company" class="border p-2 rounded" />
          <textarea id="field-address" placeholder="Address" class="border p-2 rounded col-span-2"></textarea>
        </div>
        <button id="btn-save" class="bg-green-600 text-white px-4 py-2 mt-4 rounded hover:bg-green-700">Save Card</button>
        <p id="save-status" class="mt-2 text-sm"></p>
      </div>
    </div>

    <!-- Saved Cards -->
    <div class="bg-white shadow-md rounded-xl p-4">
      <h3 class="text-xl font-semibold mb-3">Saved Cards</h3>
      <div id="card-list" class="grid gap-4"></div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwHj3POZOqg1TW9qB6piizcgXhZPWtjkqWWqefnF422KoniNS_XE0ThhmQW6ftjmOAHdg/exec"; // Replace with your Apps Script Web App URL

    // ------------------ LOGIN ------------------
    document.getElementById("btn-login").addEventListener("click", () => {
      const user = document.getElementById("login-user").value.trim();
      const pass = document.getElementById("login-pass").value.trim();
      if (user === "Admin" && pass === "admin123") {
        document.getElementById("login-section").classList.add("hidden");
        document.getElementById("dashboard").classList.remove("hidden");
        loadCards();
      } else {
        document.getElementById("login-status").innerText = "Invalid credentials!";
      }
    });

    // ------------------ OCR FUNCTIONALITY ------------------
    async function runOCR(file) {
      const status = document.getElementById("ocr-status");
      status.textContent = "Starting OCR...";

      try {
        const worker = Tesseract.createWorker({
          logger: m => {
            if (m.status === "recognizing text") {
              status.textContent = `Recognizing: ${(m.progress * 100).toFixed(0)}%`;
            }
          },
        });
        await worker.load();
        await worker.loadLanguage("eng");
        await worker.initialize("eng");

        const { data: { text } } = await worker.recognize(file);
        await worker.terminate();

        status.textContent = "OCR complete. Auto-filling fields...";
        fillFieldsFromText(text);
      } catch (err) {
        console.error(err);
        status.textContent = "OCR failed — try again with a clearer image.";
      }
    }

    function fillFieldsFromText(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      const email = text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-z]{2,}/);
      const phone = text.match(/(\+?\d[\d\s\-]{7,}\d)/);

      document.getElementById("field-name").value = lines[0] || "";
      document.getElementById("field-company").value = lines[1] || "";
      document.getElementById("field-email").value = email ? email[0] : "";
      document.getElementById("field-phone").value = phone ? phone[0] : "";
      document.getElementById("field-address").value = lines.slice(2).join(", ");

      document.getElementById("preview").classList.remove("hidden");
    }

    document.getElementById("btn-run-ocr").addEventListener("click", () => {
      const file = document.getElementById("file-input").files[0];
      if (!file) return alert("Please select an image.");
      document.getElementById("card-image").src = URL.createObjectURL(file);
      runOCR(file);
    });

    // ------------------ SAVE CARD ------------------
    document.getElementById("btn-save").addEventListener("click", async () => {
      const name = document.getElementById("field-name").value;
      const email = document.getElementById("field-email").value;
      const phone = document.getElementById("field-phone").value;
      const company = document.getElementById("field-company").value;
      const address = document.getElementById("field-address").value;
      const imgFile = document.getElementById("file-input").files[0];

      const saveStatus = document.getElementById("save-status");
      saveStatus.textContent = "Uploading...";

      const reader = new FileReader();
      reader.onloadend = async () => {
        const base64Image = reader.result.split(",")[1];
        const data = { name, email, phone, company, address, imageBase64: base64Image, fileName: imgFile.name };
        try {
          const res = await fetch(SCRIPT_URL, {
            method: "POST",
            body: JSON.stringify(data),
          });
          if (res.ok) {
            saveStatus.textContent = "✅ Card uploaded successfully!";
            loadCards();
          } else {
            saveStatus.textContent = "❌ Upload failed.";
          }
        } catch (err) {
          console.error(err);
          saveStatus.textContent = "❌ Network error while saving.";
        }
      };
      reader.readAsDataURL(imgFile);
    });

    // ------------------ LOAD CARDS ------------------
    async function loadCards() {
      try {
        const res = await fetch(SCRIPT_URL);
        const data = await res.json();
        const list = document.getElementById("card-list");
        list.innerHTML = "";
        data.slice(1).forEach(row => {
          const [id, name, email, phone, company, address, img, date] = row;
          const card = document.createElement("div");
          card.className = "p-3 border rounded shadow-sm bg-gray-50";
          card.innerHTML = `
            <img src="${img}" class="w-24 h-24 object-cover rounded mb-2" />
            <p><strong>${name}</strong></p>
            <p>${company}</p>
            <p>${email}</p>
            <p>${phone}</p>
            <p>${address}</p>
            <button onclick="deleteCard('${id}')" class="bg-red-600 text-white px-2 py-1 mt-2 rounded text-sm hover:bg-red-700">Delete</button>
          `;
          list.appendChild(card);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // ------------------ DELETE CARD ------------------
    async function deleteCard(id) {
      if (!confirm("Delete this card?")) return;
      await fetch(SCRIPT_URL + "?id=" + id, { method: "DELETE" });
      loadCards();
    }
  </script>
</body>
</html>
